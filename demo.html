<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="css/index.css" type="text/css" rel="stylesheet"/>

    <title>kyDatagrid Demo</title>
    <style>
        * { margin: 0; padding: 0; }
        body { width: 1000px; margin: 0 auto; }
        h1 { font-size: 40px; text-align: center; margin: 10px 0; }
        h3 { font-size: 16px; text-align: center; margin: 10px 0; }
        h3 a { font-size: 16px; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>
<h1>kyDatagrid Demo</h1>
<h3>Author : <a href="mailto:huzhaobin@kingyea.com.cn">Mushi</a></h3>
<table id="demoTable"></table>
</body>

<script src="js/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="js/template.js" type="text/javascript"></script>
<script src="js/kyDatagrid.min.js" type="text/javascript"></script>
<!-- kyDatagrid 表格模板 -->
<script id="kyDatagrid" type="text/html">
    <!-- 表头 -->
    {{"" | outputTitleUpdate: options,totalWidth}}

    <!-- 表格主体 -->
    {{if rows.length <= 0}}
    <tr>
        {{options.emptyMsg | outputEmptyMsg:options}}
    </tr>
    {{else}}
    {{"" | outputContentUpdate:options,rows}}
    <!--
    {{each rows as row index}}
    <tr id="kyDatagrid-row-{{index}}" class="kyDatagrid-row" index="{{index}}">

        {{if options.rownumbers}}
        <td class="center">{{(options.pageNumber - 1 ) * options.pageSize + index + 1}}</td>
        {{/if}}

        {{if options.enableChecked}}
        <td class="center">
            <input type="checkbox" class="kyDatagridCheckbox"/>
        </td>
        {{/if}}

        {{each realColumns as col j}}
        {{if row[col.field] != undefined}}
        {{row[col.field] | outputContent:row,index,col}}
        {{else}}
        {{"" | outputContent:row,index,col}}
        {{/if}}
        {{/each}}
    </tr>
    {{/each}}
    -->
    <!-- 空行遍历 -->

    <!--{{each emptyRows as emptyRow index}}-->
    <!--<tr class="kyDatagrid-row empty-row">-->
    <!--{{if options.rownumbers}}-->
    <!--<td></td>-->
    <!--{{/if}}-->
    <!--&lt;!&ndash; 是否可以复选 &ndash;&gt;-->
    <!--{{if options.enableChecked}}-->
    <!--<td></td>-->
    <!--{{/if}}-->
    <!--{{options.pageSize | outputEmptyRow:options}}-->
    <!--</tr>-->
    <!--{{/each}}-->
    {{/if}}
</script>

<!-- kyDatagrid 表格分页模板 -->
<script id="kyDatagridPage" type="text/html">
    <div class="fenye">
        <div class="left list-show">第{{rowBegin}}到{{rowEnd}}条记录，共{{totalCount}}条</div>
        <ul class="right page-box">
            <li class="pre" pageno="{{pageNo-1}}"><a class="{{if pageNo <= 1}}hui{{/if}}" href="javascript:void(0)">上一页</a></li>
            {{each pageScope as page}}
            {{if page==pageNo}}
            <li class="num active" pageno="{{page}}"><a href="javascript:void(0)" class="">{{page}}</a></li>
            {{else}}
            <li class="num" pageno="{{page}}"><a href="javascript:void(0)" class="">{{page}}</a></li>
            {{/if}}
            {{/each}}
            <li class="next" pageno={{pageNo+1}}><a class="{{if pageNo >= totalPage}}hui{{/if}}" href="javascript:void(0)">下一页</a></li>
        </ul>
        <div class=" clearfix"></div>
    </div>
</script>

<script type="text/javascript">
    // 格式化输出表格标题
    template.helper('outputTitle', function (title, column, totalWidth, queryParams) {
        var th = $("<th>");
        th.attr("field", column.field);
        th.html(column.title);
        // 列是否可排序
        if (column.sortable == true) {
            th.addClass("sortable");
            if (column.field == queryParams.sort && queryParams.order == "desc") {
                th.addClass("down");
            }
            else if (column.field == queryParams.sort && queryParams.order == "asc") {
                th.addClass("up");
            }
        }
        // 列是否隐藏
        if (column.hidden == true) {
            th.css("display", "none");
        }

        var titleAlign = column.titleAlign || column.align;
        switch (titleAlign) {
            case 'left':
                th.css("text-align", "left");
                break;
            case 'center':
                th.css("text-align", "center");
                break;
            case 'right':
                th.css("text-align", "right");
                break;
            default:
                th.css("text-align", "left");
                break;
        }
        // 宽度自适应
        var columnWidth = column.width == undefined ? 100 : column.width;
        th.css("width", columnWidth / totalWidth * 100 + "%");

        return th[0].outerHTML;
    });

    // 格式化输出单元格内容
    template.helper('outputContent', function (value, row, index, column) {
        if (column.hidden == true) {
            return "";
        }
        var td = $("<td>");
        // 是否需要格式化输出
        if (column.formatter != undefined && column.formatter != null) {
            td.html(column.formatter(value, row, index))
        }
        else {
            td.html(value);
        }

        switch (column.align) {
            case 'left':
                td.css("text-align", "left");
                break;
            case 'center':
                td.css("text-align", "center");
                break;
            case 'right':
                td.css("text-align", "right");
                break;
            default:
                td.css("text-align", "left");
                break;
        }
        return td[0].outerHTML;
    });

    // 格式化输出空行
    template.helper('outputEmptyRow', function (pageSize, options) {
        var tr = "";
        var columns = options.columns;
        for (var i = 0; i < columns.length; i++) {
            var col = columns[i];
            if (!col.hidden) {
                tr += "<td></td>";
            }
        }
        return tr;
    });

    // 空数据时输出
    template.helper('outputEmptyMsg', function (emptyMsg, options) {
        var td = $("<td>");
        var columnsLen = getRealColumns(options.columns).length;
        if (options.enableChecked) {
            columnsLen++;
        }
        if (options.rownumbers) {
            columnsLen++;
        }
        td.attr("colspan", columnsLen);
        td.attr("align", "center");
        td.html(options.emptyMsg);
        return td[0].outerHTML;
    });


    template.helper('outputTitleUpdate', function (value, options, totalWidth) {
        var length = getMaxDeepLength(options.columns);
        // 获取当前表格的宽度
        var totalWidth = getTotalWidth(getRealColumns(options.columns));
        var queryParams = options.queryParams;
        var rows = new Array(length);
        for (var i = 0; i < length; i++) {
            rows[i] = [];
        }
        // 获取解析后的表头行配置
        rows = resolveHeader(options.columns, rows);
        var thead = $("<thead>");
        // 遍历输出表头行
        for (var i = 0; i < rows.length; i++) {
            var tr = $("<tr>");
            // 第一行需要初始化 行号列单元格 和 全选框单元格
            if (i == 0) {
                // 添加行号列单元格
                if (options.rownumbers) {
                    var rowNumTh = $("<th>");
                    rowNumTh.css({"min-width": "36px", "max-width": "36px"})
                            .attr("rowspan", rows.length);
                    tr.append(rowNumTh);
                }
                // 添加全选框单元格
                if (options.enableChecked) {
                    var checkBoxTh = $("<th>");
                    checkBoxTh.css({"min-width": "36px", "max-width": "36px", "text-align": "center"})
                            .attr("rowspan", rows.length)
                            .append("<input type='checkbox' id='kyDatagridAllCheckbox'>");
                    tr.append(checkBoxTh);
                }
            }

            // 获取每行配置
            var row = rows[i];
            // 遍历当前行，输出每个单元格
            for (var j = 0; j < row.length; j++) {
                var column = row[j];
                var th = $("<th>");
                th.attr("field", column.field);
                th.html(column.title);
                // 列是否可排序
                if (column.sortable == true) {
                    th.addClass("sortable");
                    if (column.field == queryParams.sort && queryParams.order == "desc") {
                        th.addClass("down");
                    }
                    else if (column.field == queryParams.sort && queryParams.order == "asc") {
                        th.addClass("up");
                    }
                }
                // 列是否隐藏
                if (column.hidden == true) {
                    th.css("display", "none");
                }

                if (column.childColumns == undefined || column.childColumns.length <= 0) {
                    th.attr("rowspan", length - i);
                    // 下方没有元素时可以 设置对齐方式
                    var titleAlign = column.titleAlign || column.align;
                    switch (titleAlign) {
                        case 'left':
                            th.css("text-align", "left");
                            break;
                        case 'center':
                            th.css("text-align", "center");
                            break;
                        case 'right':
                            th.css("text-align", "right");
                            break;
                        default:
                            th.css("text-align", "left");
                            break;
                    }
                    // 下方没有元素时可以 设置宽度自适应
                    var columnWidth = column.width == undefined ? 100 : column.width;
                    th.css("width", columnWidth / totalWidth * 100 + "%");
                } else {
                    th.css("text-align", "center");
                    th.attr("colspan", getColspan(column.childColumns));
                }
                tr.append(th);
            }

            thead.append(tr);
        }
        return thead[0].outerHTML;
    });


    template.helper('outputContentUpdate', function (value, options, rows) {
        var columns = getRealColumns(options.columns);
        var tbody = $("<tbody>");
        for (var i = 0; i < rows.length; i++) {
            var tr = $("<tr>");
            var row = rows[i];
            tr.attr("id", "kyDatagrid-row-" + i)
                    .attr("index", i)
                    .addClass("kyDatagrid-row")
            // 是否显示行号
            if (options.rownumbers) {
                var rowNumTd = $("<td>");
                rowNumTd.html((options.pageNumber - 1 ) * options.pageSize + i + 1);
                rowNumTd.addClass("center");
                tr.append(rowNumTd);
            }
            // 是否显示复选框
            if (options.enableChecked) {
                var checkboxTd = $("<td>");
                checkboxTd.html('<input type="checkbox" class="kyDatagridCheckbox"/>');
                checkboxTd.addClass("center");
                tr.append(checkboxTd);
            }
            // 遍历输出每个单元格
            for (var j = 0; j < columns.length; j++) {
                var td = $("<td>");
                var column = columns[j];
                var value = row[column.field] || "";
                // 是否需要格式化输出
                if (column.formatter) {
                    td.html(column.formatter(value, row, i))
                }
                else {
                    td.html(value);
                }

                switch (column.align) {
                    case 'left':
                        td.css("text-align", "left");
                        break;
                    case 'center':
                        td.css("text-align", "center");
                        break;
                    case 'right':
                        td.css("text-align", "right");
                        break;
                    default:
                        td.css("text-align", "left");
                        break;
                }
                tr.append(td);
            }
            tbody.append(tr);
        }
        return tbody[0].outerHTML;
    });

    // 递归获取columns的最深层数
    function getMaxDeepLength(columns, length) {
        length = length || 0;
        // 调用默认增加一层深度，初始从 0 开始
        var maxLength = ++length;

        for (var i = 0; i < columns.length; i++) {
            var column = columns[i];
            // 有子表头且长度不小于 0 时进行递归
            if (column.childColumns && column.childColumns.length > 0) {
                // 获取该列的深度。
                var theLength = getMaxDeepLength(column.childColumns, length);
                // 判断是否比当前最大深度大
                if (theLength > maxLength) {
                    maxLength = theLength;
                }
            }
        }
        return maxLength;
    }

    // 解析表头，将一层数组转换成多层数组
    function resolveHeader(columns, rows, length) {
        // 初始为 -1 ，因为数组下标从 0 开始，方便使用
        length = length || 0;

        // 调用默认增加一层深度，初始从 -1 开始
        var curLength = ++length;

        for (var i = 0; i < columns.length; i++) {
            var column = columns[i];
            rows[length - 1].push(column);

            if (column.childColumns && column.childColumns.length > 0) {
                rows = resolveHeader(column.childColumns, rows, curLength);
            }
        }
        return rows;
    }

    // 获取当前表头跨列数量
    function getColspan(columns, length) {
        length = length || 0;
        for (var i = 0; i < columns.length; i++) {
            var column = columns[i];
            // 有子表头时不需要计算当前数量
            if (column.childColumns && column.childColumns.length > 0) {
                length = getColspan(column.childColumns, length);
            } else {
                length++;
            }
        }

        return length;

    }

    // 计算表格总宽度
    function getTotalWidth(columns) {
        var totalWidth = 0;
        for (var i = 0; i < columns.length; i++) {
            var column = columns[i];
            if (!column.hidden) {
                var width = column.width == undefined ? 100 : column.width;
                totalWidth += width;
            }
        }
        return totalWidth;
    }

    // 获取表格实际显示时的列对象
    function getRealColumns(columns, realColumns) {
        realColumns = realColumns || [];
        for (var i = 0; i < columns.length; i++) {
            var column = columns[i];
            // 有子表头且长度不小于 0 时进行递归
            if (column.childColumns && column.childColumns.length > 0) {
                realColumns = getRealColumns(column.childColumns, realColumns);
            }
            // 没有子表头时表示是最下面一行，直接放入 realColumns
            else {
                if (!column.hidden) {
                    realColumns.push(column);
                }
            }
        }
        return realColumns;
    }
</script>
<script type="text/javascript">
    $(function () {
        $("#demoTable").kyDatagrid({
            title: "办公设备",
            method: "get",
            url: 'data.json',
            border: true,
            idField: 'id',
            pagination: true,
            singleSelect: false,
            rownumbers: true,
            enableChecked: true,
            pageNumber: 1,
            emptyMsg: '这里没有数据！',
            pageSize: 15,
            columns: [
                {field: 'ID', title: 'ID', width: 100, hidden: true},
                {field: 'name', title: '商品名称', width: 100, sortable: true},
                {
                    field: 'status', title: '商品状态', width: 100, align: 'center', titleAlign: 'left',
                    formatter: function (val, row, index) {
                        switch (val) {
                            case 1 :
                                return "上架";
                                break;
                            case 2 :
                                return "缺货";
                                break;
                        }
                    }
                },
                {
                    field: 'productValue', title: '商品属性', width: 100,
                    childColumns: [
                        {
                            field: 'info', title: '基本信息', width: 100,
                            childColumns: [
                                {field: 'unit', title: '单位', width: 100},
                                {field: 'num', title: '数量', width: 100, sortable: true},
                                {field: 'price', title: '单价', width: 100, align: 'right', sortable: true}
                            ]
                        },
                        {field: 'value1', title: '高级属性一', width: 100},
                        {field: 'value2', title: '高级属性二', width: 100},
                        {field: 'value3', title: '高级属性三', width: 100}
                    ]
                },
                {
                    field: 'stock', title: '库存信息', width: 100,
                    childColumns: [
                        {field: 'total', title: '总数', width: 100, sortable: true},
                        {field: 'sell', title: '已售', width: 100, sortable: true},
                        {field: 'left', title: '剩余', width: 100, sortable: true}
                    ]
                },
                {
                    field: 'oper', title: '操作', width: 100,
                    formatter: function (val, row, index) {
                        if (index % 2 == 0) {
                            return "<a class='btn-blue' href='javascript:void(0)' onclick='getSelections()'>按钮</a>"
                        } else {
                            return "<button class='btn-blue' href='javascript:void(0)'>按钮</button>"
                        }
                    }
                }
            ],
            onLoadSuccess: function () {
            },
            onDblClickRow: function (index, row) {
            }
        });
    });


    function getSelections() {
        console.log($("#demoTable").kyDatagrid('getSelections'));
    }
</script>
</html>