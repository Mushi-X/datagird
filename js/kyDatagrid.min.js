(function($){$.fn.kyDatagrid=function(options,param){if(typeof options=='string'){return $.fn.kyDatagrid.methods[options](this,param)}options=options||{};return this.each(function(){var state=$.data(this,'kyDatagrid');if(state){$.extend(state.options,options)}else{options=$.extend({},$.fn.kyDatagrid.defaults,$.fn.kyDatagrid.parseOptions(this),options);$.data(this,'kyDatagrid',{options:options});reload(this)}})};$.fn.kyDatagrid.defaults={title:undefined,url:undefined,idField:"id",method:'post',queryParams:{},enableChecked:false,columns:undefined,rownumbers:true,pagination:true,pageNumber:1,singleSelect:true,pageSize:10,pageList:[10,20,30,40,50],maxPageLen:10,emptyMsg:'记录为空!',onLoadSuccess:function(rows){},onLoadError:function(){},onDblClickRow:function(index,row){},onSelect:function(index,row){},onUnSelect:function(index,row){},onSelectAll:function(rows){},onUnSelectAll:function(rows){}};$.fn.kyDatagrid.methods={options:function(jq){return $.data(jq[0],'kyDatagrid').options},reload:function(jq,params){return jq.each(function(){reload(this,params)})},remove:function(jq){return jq.each(function(){removeTable(this)})},getSelected:function(jq){return getSelected(jq[0])},getSelections:function(jq){return $.data(jq[0],"kyDatagrid").selectedRows||[]},checkRow:function(jq,index){return jq.each(function(){checkRow(this,index)})},checkAll:function(jq){return jq.each(function(){checkAll(this)})},unCheckRow:function(jq,index){return jq.each(function(){unCheckRow(this,index)})},unCheckAll:function(jq){return jq.each(function(){unCheckAll(this)})}};$.fn.kyDatagrid.parseOptions=function(target){return{}};function createTable(target,rows,options){if(options.pagination&&rows.length>options.pageSize){rows=rows.slice(0,options.pageSize)}var emptyRows=[];var emptyLen=options.pageSize-rows.length; while(emptyLen-->0){emptyRows.push("")}var totalWidth=0;for(var i=0;i<options.columns.length;i++){var column=options.columns[i];if(!column.hidden){var width=column.width==undefined?100:column.width;totalWidth+=width}}var html=template('kyDatagrid',{rows:rows,emptyRows:emptyRows,options:options,totalWidth:totalWidth});$(target).html(html);$(target).addClass("data-table marb-10 kyDatagrid");var selectedRows=$.data(target,'kyDatagrid').selectedRows||[]}function createPagination(target,totalCount,options){var totalCount=parseInt(totalCount);var pageNo=parseInt(options.pageNumber);var maxPageLen=parseInt(options.maxPageLen);var pageSize=parseInt(options.pageSize);var totalPage=(totalCount%pageSize==0)?totalCount/pageSize:(parseInt(totalCount/pageSize)+1);maxPageLen=totalPage>maxPageLen?maxPageLen:totalPage;var begin=1;if(pageNo<maxPageLen/2){begin=1}else if((totalPage-pageNo)<maxPageLen/2){begin=totalPage-maxPageLen+1}else{begin=pageNo-maxPageLen/2}begin=begin>0?begin:1;var pageScope=[];var len=begin+maxPageLen;for(begin;begin<len;begin++){pageScope.push(begin)}var rowBegin=totalCount>0?(pageNo-1)*pageSize+1:0;var rowEnd=pageNo*pageSize>totalCount?totalCount:pageNo*pageSize;var html=template('kyDatagridPage',{totalCount:totalCount,pageNo:pageNo,pageSize:pageSize,totalPage:totalPage,pageScope:pageScope,rowBegin:rowBegin,rowEnd:rowEnd});$(target).after(html);$(target).next('.fenye').find(".page-box li a").on("click",function(){if($(this).hasClass("hui")||$(this).hasClass("cur")){return}var pageno=$(this).parent().attr("pageno");if(pageno==pageNo){return}else{var options=$(target).kyDatagrid('options');options.pageNumber=pageno;var kyDatagridData=$.data(target,'kyDatagrid');kyDatagridData.options=options;$.data(target,'kyDatagrid',kyDatagridData);$(target).kyDatagrid('reload')}})}function reload(target,params){showLoading();var options=$.data(target,'kyDatagrid').options;if(params!=undefined&&typeof params=="object"){options.queryParams=params}var queryParams=options.queryParams,params;if(options.pagination){$.extend(queryParams,{page:options.pageNumber,rows:options.pageSize})}$.ajax({url:options.url,type:options.method,data:queryParams,dataType:'json',success:function(data){data=formatResult(options,data);removeTable(target);createTable(target,data.rows,options);if(options.pagination){createPagination(target,data.total,options)}bindEvent(target);var kyDatagridData=$.data(target,'kyDatagrid');kyDatagridData.options=options;kyDatagridData.rows=data.rows;$.data(target,'kyDatagrid',kyDatagridData);options.onLoadSuccess(data);removeLoading()},error:function(XMLHttpRequest,textStatus,errorThrown){createTable(target,[],options);if(options.pagination){createPagination(target,0,options)}options.onLoadError()}})}function removeTable(target){$(target).html("");$(target).next(".fenye").remove()}function bindEvent(target){var options=$(target).kyDatagrid('options');$(target).find("th.sortable").click(function(event){var order="desc";var field=$(this).attr("field");if($(this).hasClass("down")){order="asc"}var queryParam=$.data(target,"kyDatagrid").options.queryParams;queryParam.sort=field;queryParam.order=order;reload(target,queryParam);event.stopPropagation()});$(target).find(".kyDatagrid-row").click(function(event){if($(this).hasClass("empty-row")){return}var rows=$.data(target,"kyDatagrid").rows;var index=$(this).attr("index");if(options.singleSelect){if(isChecked(target,index)){unCheckAll(target)}else{unCheckAll(target);checkRow(target,index)}}else if(!$(this).hasClass("selected")){checkRow(target,index)}else{unCheckRow(target,index)}event.stopPropagation()});$(target).find(".kyDatagrid-row").dblclick(function(event){var rows=$.data(target,"kyDatagrid").rows;var index=$(this).attr("index");$.data(target,"kyDatagrid").options.onDblClickRow(index,rows[index]);event.stopPropagation()});if(options.enableChecked){$(target).find("#kyDatagridAllCheckbox").on("click",function(){if(options.singleSelect){$(this).prop('checked',false)}else{if(!$(this).prop("checked")){unCheckAll(target)}else{checkAll(target)}}})}$(target).find("a,button").click(function(event){event.stopPropagation()})}function isChecked(target,index){var row=$(target).find("#kyDatagrid-row-"+index);if(row.hasClass("selected")){return true}return false}function checkRow(target,index){var row=$(target).find("#kyDatagrid-row-"+index);if(row.hasClass("selected")){return}row.addClass("selected");var kyDatagridData=$.data(target,'kyDatagrid');var rows=kyDatagridData.rows||[];var selectedRows=kyDatagridData.selectedRows||[];var options=kyDatagridData.options;if(options.enableChecked){row.find(".kyDatagridCheckbox").prop("checked",true);var idField=options.idField;var isExist=false;for(var i=0;i<selectedRows.length;i++){if(selectedRows[i][idField]==rows[index][idField]){isExist=true}}if(!isExist){selectedRows.push(rows[index]);kyDatagridData.selectedRows=selectedRows}$.data(target,'kyDatagrid',kyDatagridData)}var isAllChecked=true;for(var i=0;i<rows.length;i++){if(!$("#kyDatagrid-row-"+i).find(".kyDatagridCheckbox").prop("checked")){isAllChecked=false}}if(isAllChecked){$(target).find("#kyDatagridAllCheckbox").prop("checked",true);options.onSelectAll(rows)}options.onSelect(index,rows[index])}function unCheckRow(target,index){var row=$(target).find("#kyDatagrid-row-"+index);if(!row.hasClass("selected")){return}row.removeClass("selected");var kyDatagridData=$.data(target,'kyDatagrid');var rows=kyDatagridData.rows==undefined?[]:kyDatagridData.rows;var selectedRows=kyDatagridData.selectedRows==undefined?[]:kyDatagridData.selectedRows;var options=kyDatagridData.options;if(options.enableChecked){row.find(".kyDatagridCheckbox").prop("checked",false);var idField=options.idField;for(var i=0;i<selectedRows.length;i++){if(selectedRows[i][idField]==rows[index][idField]){selectedRows.splice(i,1)}}$.data(target,'kyDatagrid',kyDatagridData);$(target).find("#kyDatagridAllCheckbox").prop("checked",false)}options.onUnSelect(index,rows[index])}function checkAll(target){var rows=$.data(target,"kyDatagrid").rows==undefined?[]:$.data(target,"kyDatagrid").rows;for(var i=0;i<rows.length;i++){checkRow(target,i)}}function unCheckAll(target){var rows=$.data(target,"kyDatagrid").rows==undefined?[]:$.data(target,"kyDatagrid").rows;for(var i=0;i<rows.length;i++){unCheckRow(target,i)}}function getSelected(target){var selectedRows=$(target).find("tr.selected");if(selectedRows.length>0){var rows=$.data(target,"kyDatagrid").rows;var firstIndex=parseInt($(selectedRows[0]).attr("index"));return rows[firstIndex]}return null}function formatResult(options,data){var pageSize=options.pageSize;var pageNo=options.pageNumber;var realData=[];if(data instanceof Array){if(options.pagination){for(var i=0,start=(pageNo-1)*pageSize;i<pageSize;i++){if(start+i>=data.length){break}realData.push(data[start+i])}}else{realData=data}return{total:data.length,rows:realData}}else if(data instanceof Object){var rows=data.rows;if(options.pagination&&rows.length>pageSize){for(var i=0;i<pageSize;i++){realData.push(rows[i])}data.rows=realData}return data}else{alert("unsupport data type.you should use Array or JSON data to create a table")}}function showLoading(){}function removeLoading(){}})(jQuery);