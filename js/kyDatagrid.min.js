(function(h){h.fn.kyDatagrid=function(G,H){if(typeof G=="string"){return h.fn.kyDatagrid.methods[G](this,H)}G=G||{};return this.each(function(){var I=h.data(this,"kyDatagrid");if(I){h.extend(I.options,G)}else{G=h.extend({},h.fn.kyDatagrid.defaults,h.fn.kyDatagrid.parseOptions(this),G);h.data(this,"kyDatagrid",{options:G,data:{total:0,rows:[]}});A(this);w(this)}})};h.fn.kyDatagrid.defaults={title:undefined,url:undefined,idField:"id",method:"post",queryParams:{},fit:false,height:250,enableChecked:false,frozenColumns:[],columns:[],rownumbers:true,pagination:true,pageNumber:1,singleSelect:true,pageSize:10,scrollBarWidth:18,pageList:[10,20,30,40,50],emptyMsg:"记录为空!",trAttr:function(H,I,G){},onLoadSuccess:function(G){},onLoadError:function(){},onDblClickRow:function(G,H){},onSelect:function(G,H){},onUnSelect:function(G,H){},onSelectAll:function(G){},onUnSelectAll:function(G){}};h.fn.kyDatagrid.methods={options:function(G){return h.data(G[0],"kyDatagrid").options},reload:function(H,G){return H.each(function(){w(this,G)})},remove:function(G){return G.each(function(){D(this)})},getSelected:function(G){return s(G[0])},getSelections:function(G){return h.data(G[0],"kyDatagrid").selectedRows||[]},checkRow:function(H,G){return H.each(function(){x(this,G)})},checkAll:function(G){return G.each(function(){q(this)})},unCheckRow:function(H,G){return H.each(function(){F(this,G)})},unCheckAll:function(G){return G.each(function(){C(this)})},loadData:function(H,G){return H.each(function(){b(this,G)})},changePage:function(H,G){return H.each(function(){y(this,G)})},hideColumn:function(H,G){return H.each(function(){c(this,G)})},showColumn:function(H,G){return H.each(function(){E(this,G)})}};h.fn.kyDatagrid.parseOptions=function(H){var G={};G.columns=l(H);G.enableChecked=h(H).attr("enableChecked")=="true";G.fit=h(H).attr("fit")=="true";G.rownumbers=h(H).attr("rownumbers")!="false";G.pagination=h(H).attr("pagination")!="false";G.singleSelect=h(H).attr("singleSelect")!="false";return G};function l(O){var Q=h(O);if(Q.find("tr").length==0){return[]}var K=[];if(Q.find("thead").length>0){var N=Q.find("thead tr");var I=new Array(N.length);for(var M=0;M<N.length;M++){I[M]=[]}for(var M=0;M<N.length;M++){var P=N[M];var G=h(P).find("th");for(var L=0;L<G.length;L++){var H=G[L];J={};J.title=h(H).html();J.field=h(H).attr("field");J.sortable=h(H).attr("sortable");J.hidden=h(H).attr("hidden");J.rowspan=h(H).attr("rowspan");J.colspan=h(H).attr("colspan")>1?h(H).attr("colspan"):undefined;J.align=h(H).attr("align");I[M].push(J)}}console.log(JSON.stringify(I));K=u(I);return K}else{var P=Q.find("tr")[0];var G=h(P).find("th");for(var M=0;M<G.length;M++){var H=G[M];var J={};J.title=h(H).html();J.field=h(H).attr("field");J.sortable=h(H).attr("sortable");J.hidden=h(H).attr("hidden");K.push(J)}return K}}function A(M){var J=h(M).kyDatagrid("options");h(M).css("display","none");h(M).wrap(h("<div class='kyDatagrid-wrap'></div>")).wrap(h("<div class='kyDatagrid-view'></div>"));var G=h(M).parents(".kyDatagrid-wrap");var L=G.find(".kyDatagrid-view");G.addClass("kyDatagrid-"+h(M).attr("id"));L.append("<div class='kyDatagrid-view-left'>").append("<div class='kyDatagrid-view-right'>").append("<div class='kyDatagrid-view-empty'>");var K=G.find(".kyDatagrid-view-left");var I=G.find(".kyDatagrid-view-right");K.append("<div class='kyDatagrid-head'>").append("<div class='kyDatagrid-body'>");K.find(".kyDatagrid-head").append("<table class='data-table'>");K.find(".kyDatagrid-body").append("<div class='kyDatagrid-body-inner'><table class='data-table'></table></div>");K.find(".kyDatagrid-head table").append(r(M,J.frozenColumns,true));I.append("<div class='kyDatagrid-head'>").append("<div class='kyDatagrid-body'>");I.find(".kyDatagrid-head").append("<div class='kyDatagrid-head-inner'><table class='data-table'></table></div>");I.find(".kyDatagrid-body").append("<table class='data-table'>");I.find(".kyDatagrid-head table").append(r(M,J.columns));var H={};H.leftView=K;H.leftHead=K.find(".kyDatagrid-head");H.leftBody=K.find(".kyDatagrid-body");H.rightView=I;H.rightHead=I.find(".kyDatagrid-head");H.rightBody=I.find(".kyDatagrid-body");h.data(M,"kyDatagrid").container=H;L.contextmenu(function(O){var N=O.target})}function b(K,J){var I=h(K).kyDatagrid("options");var J=z(I,J);var G=h(K).parents(".kyDatagrid-wrap");G.find(".kyDatagrid-view-left .kyDatagrid-body table").empty().append(B(K,J.rows,true));G.find(".kyDatagrid-view-right .kyDatagrid-body table").empty().append(B(K,J.rows));var H=h.data(K,"kyDatagrid");H.options=I;H.data=J;h.data(K,"kyDatagrid",H);if(I.pagination){j(K)}g(K);v(K);d(K);return J}function g(I){var H=h(I).kyDatagrid("options");var G=h(I).parents(".kyDatagrid-wrap");G.find("th.sortable").unbind("click").click(function(L){var J="desc";var M=h(this).attr("field");if(h(this).hasClass("down")){J="asc"}G.find("th.sortable").removeClass("down").removeClass("up");if(J=="asc"){h(this).addClass("up")}else{h(this).addClass("down")}var K=h.data(I,"kyDatagrid").options.queryParams;
    K.sort=M;K.order=J;w(I,K)});G.find(".kyDatagrid-view-right .kyDatagrid-body").scroll(function(J){a(I)});G.find(".kyDatagrid-row").hover(function(){var J=h(this).attr("index");h(I).parents(".kyDatagrid-wrap").find("tr#kyDatagrid-row-"+J).addClass("hover")},function(){var J=h(this).attr("index");h(I).parents(".kyDatagrid-wrap").find("tr#kyDatagrid-row-"+J).removeClass("hover")});G.find(".kyDatagrid-row").unbind("click").click(function(K){if(h(this).hasClass("empty-row")){return}var L=h.data(I,"kyDatagrid").data.rows;var J=h(this).attr("index");if(H.singleSelect){if(i(I,J)){C(I)}else{C(I);x(I,J)}}else{if(!h(this).hasClass("selected")){x(I,J)}else{F(I,J)}}});G.find(".kyDatagrid-row").unbind("dblclick").dblclick(function(K){var L=h.data(I,"kyDatagrid").data.rows;var J=h(this).attr("index");h.data(I,"kyDatagrid").options.onDblClickRow(J,L[J])});if(H.enableChecked){G.find("#kyDatagridAllCheckbox").unbind("click").click(function(){if(H.singleSelect){h(this).prop("checked",false)}else{if(!h(this).prop("checked")){C(I)}else{q(I)}}})}h(window).resize(function(){v(I);d(I);a(I)})}function a(I){var G=h(I).parents(".kyDatagrid-wrap");var H=G.find(".kyDatagrid-view-right .kyDatagrid-body").scrollTop();G.find(".kyDatagrid-view-left .kyDatagrid-body").scrollTop(H);var J=G.find(".kyDatagrid-view-right .kyDatagrid-body").scrollLeft();G.find(".kyDatagrid-view-right .kyDatagrid-head").scrollLeft(J)}function j(N){var T=h(N).kyDatagrid("options");h(N).parents(".kyDatagrid-wrap").find(".pagination").remove();var S=h.data(N,"kyDatagrid").data.total;var I=h(N).parents(".kyDatagrid-wrap");S=parseInt(S);var G=parseInt(T.pageNumber);var Q=parseInt(T.pageSize);var M=(S%Q==0)?S/Q:(parseInt(S/Q)+1);M=M==0?1:M;var J=S>0?(G-1)*Q+1:0;var O=G*Q>S?S:G*Q;var R=h("<div class='pagination '></div>");var P=h('<div class="page-box">'+'<div class="left show-g">'+"<ul>"+'<li><select class="pagination-page-list"></select></li>'+'<li><a href="javascript:void(0)" class="pagination-first"></a><a href="javascript:void(0)" class="pagination-prev"></a></li>'+'<li>第<input type="text" class="pagination-num" name="pagination-num"> 共<span class="pagination-total-page"></span>页 </li>'+'<li> <a href="javascript:void(0)" class="pagination-next"></a><a href="javascript:void(0)" class="pagination-last"></a></li>'+'<li> <a href="javascript:void(0)" class="pagination-load"></a></li>'+"</ul>"+"</div>"+'<div class="pagination-info">显示第0到0条，共0条</div>'+"</div>");var H=P.find("select.pagination-page-list");for(var K=0;K<T.pageList.length;K++){var L=h("<option>");L.html(T.pageList[K]);L.val(T.pageList[K]);if(T.pageSize==T.pageList[K]){L.prop("selected",true)}L.appendTo(H)}H.on("change",function(V){var U=h(this).val();T.pageSize=U;h.data(N,"kyDatagrid").options=T;y(N,1)});R.append(P);P.find("input.pagination-num").val(G);R.on("keyup","input.pagination-num",function(U){if(U.which==13){var V=h(this).val();y(N,V)}});R.find(".pagination-total-page").html(M);R.find(".pagination-info").html("显示第"+J+"到"+O+"条，共"+S+"条");h(I).append(R);R.find(".pagination-first").on("click",function(){y(N,1)});R.find(".pagination-prev").on("click",function(){y(N,G-1)});R.find(".pagination-next").on("click",function(){y(N,G+1)});R.find(".pagination-last").on("click",function(){y(N,M)});R.find(".pagination-load").on("click",function(){w(N)})}function y(K,G){var H=h(K).kyDatagrid("options");var J=h.data(K,"kyDatagrid");var I=(J.data.total%H.pageSize==0)?J.data.total/H.pageSize:(parseInt(J.data.total/H.pageSize)+1);if((/^(\+|-)?\d+$/.test(G))&&G>0){if(G>I){G=I}}else{G=1}H.pageNumber=G;w(K)}function w(K,L){var G=h(K).kyDatagrid("options");if(L!=undefined&&typeof L=="object"){G.queryParams=L}var H=G.queryParams,L;if(G.pagination){h.extend(H,{page:G.pageNumber,rows:G.pageSize})}var J=[];if(G.url!=undefined){h.ajax({url:G.url,type:G.method,data:H,dataType:"json",success:function(M){M=b(K,M);G.onLoadSuccess(M.rows)},error:function(M,O,N){b(K,[]);G.onLoadError()}})}else{var I=G.data||[];I=b(K,I);G.onLoadSuccess(I.rows)}}function D(G){h(G).siblings().remove();h(G).unwrap().siblings().remove();h(G).unwrap()}function v(L){var P=h(L).kyDatagrid("options");var M=h(L).parents(".kyDatagrid-wrap");if(P.fit||P.height){var G=h(window).height()-P.scrollBarWidth-10;var H=h(L).parents(".kyDatagrid-wrap").offset().top;var K=35*t(P.columns);var O=h(".pagination").height();var N=P.fit?(G-H):P.height;N=N<(K+O)?K+O:N;N+=P.scrollBarWidth;var J=N;if(P.pagination){J-=31}var I=M.find(".kyDatagrid-body-inner table").height();M.css("height",N);M.find(".kyDatagrid-view").css("height",J);M.find(".kyDatagrid-view-left").css("height",J);M.find(".kyDatagrid-view-right").css("height",J);M.find(".kyDatagrid-head").css("height",K);M.find(".kyDatagrid-view-left .kyDatagrid-body").css("height",J-K);M.find(".kyDatagrid-view-left .kyDatagrid-body-inner").css("height",I+P.scrollBarWidth);M.find(".kyDatagrid-view-right .kyDatagrid-body").css("height",J-K)}}function d(W){var L=h(W).kyDatagrid("options");var H=[];var I=h(W).parents(".kyDatagrid-wrap");var U=I.width();
    U=I.parent().width();I.css("width",U);var X=n(p(L.frozenColumns));var N=o(X);var R=N;for(var T=0;T<X.length;T++){var J=X[T];if(J.hidden==undefined||!J.hidden){var M=J.width==undefined?100:J.width;var O=".kyDatagrid-cl-"+J.field;var S=parseInt(M/N*R)-12;H.push(""+O+" {width:"+S+"px}")}}if(L.rownumbers){R+=36}if(L.enableChecked){R+=36}I.find(".kyDatagrid-view-left").css("width",R);I.find(".kyDatagrid-view-left .kyDatagrid-head").css("width",R);I.find(".kyDatagrid-view-left .kyDatagrid-body").css("width",R);I.find(".kyDatagrid-view-left .kyDatagrid-head table").css("width",R);I.find(".kyDatagrid-view-left .kyDatagrid-body table").css("width",R);var P=n(p(L.columns));var K=o(P);var V=U-R;var G=K;var Q=V>G?V:G;Q=Q-L.scrollBarWidth;I.find(".kyDatagrid-view-right").css("width",V);I.find(".kyDatagrid-view-right .kyDatagrid-head").css("width",V);I.find(".kyDatagrid-view-right .kyDatagrid-head").css("width",V+L.scrollBarWidth);I.find(".kyDatagrid-view-right .kyDatagrid-body").css("width",V);I.find(".kyDatagrid-view-right .kyDatagrid-head table").css("width",Q);I.find(".kyDatagrid-view-right .kyDatagrid-body table").css("width",Q);for(var T=0;T<P.length;T++){var J=P[T];if(J.hidden==undefined||!J.hidden){var M=J.width==undefined?100:J.width;var O=".kyDatagrid-cl-"+J.field;var S=Math.floor(M/K*Q)-13;H.push(""+O+" {width:"+S+"px}")}}f(W,H)}function i(H,G){var I=h(H).parents(".kyDatagrid-wrap").find("#kyDatagrid-row-"+G);if(I.hasClass("selected")){return true}return false}function x(M,K){var N=h(M).parents(".kyDatagrid-wrap");var P=N.find("tr#kyDatagrid-row-"+K);if(P.hasClass("selected")){return}P.addClass("selected");var O=h.data(M,"kyDatagrid");var Q=O.data.rows||[];var H=O.selectedRows||[];var R=O.options;if(R.enableChecked){P.find(".kyDatagridCheckbox").prop("checked",true)}var G=R.idField;var L=false;for(var J=0;J<H.length;J++){if(H[J][G]==Q[K][G]){L=true}}if(!L){H.push(Q[K]);O.selectedRows=H}h.data(M,"kyDatagrid",O);var I=true;for(var J=0;J<Q.length;J++){if(!h("#kyDatagrid-row-"+J).find(".kyDatagridCheckbox").prop("checked")){I=false}}if(I){N.find("#kyDatagridAllCheckbox").prop("checked",true);R.onSelectAll(Q)}R.onSelect(K,Q[K])}function F(K,J){var L=h(K).parents(".kyDatagrid-wrap");var N=L.find("tr#kyDatagrid-row-"+J);if(!N.hasClass("selected")){return}N.removeClass("selected");var M=h.data(K,"kyDatagrid");var O=M.data.rows==undefined?[]:M.data.rows;var H=M.selectedRows==undefined?[]:M.selectedRows;var P=M.options;if(P.enableChecked){N.find(".kyDatagridCheckbox").prop("checked",false);L.find("#kyDatagridAllCheckbox").prop("checked",false)}var G=P.idField;for(var I=0;I<H.length;I++){if(H[I][G]==O[J][G]){H.splice(I,1)}}h.data(K,"kyDatagrid",M);P.onUnSelect(J,O[J])}function q(I){var H=h.data(I,"kyDatagrid").data.rows==undefined?[]:h.data(I,"kyDatagrid").data.rows;for(var G=0;G<H.length;G++){x(I,G)}}function C(I){var H=h.data(I,"kyDatagrid").data.rows==undefined?[]:h.data(I,"kyDatagrid").data.rows;for(var G=0;G<H.length;G++){F(I,G)}}function s(J){var I=h(J).parents(".kyDatagrid-wrap").find("tr.selected");if(I.length>0){var H=h.data(J,"kyDatagrid").data.rows;var G=parseInt(h(I[0]).attr("index"));return H[G]}return null}function z(I,L){var H=I.pageSize;var G=I.pageNumber;var K=[];if(L instanceof Array){if(I.pagination){for(var J=0,M=(G-1)*H;J<H;J++){if(M+J>=L.length){break}K.push(L[M+J])}}else{K=L}return{total:L.length,rows:K}}else{if(L instanceof Object){return L}else{alert("unsupport data type.you should use Array or JSON data to create a table")}}}function r(ab,J,aa){var N=h(ab).kyDatagrid("options");var O=t(J);var V=t(N.columns);var H=t(N.frozenColumns);var Q=V>H?V:H;var M=o(p(J));var G=N.queryParams;var T=new Array(O);for(var Y=0;Y<O;Y++){T[Y]=[]}T=e(J,T);var Z=h("<thead>");for(var Y=0;Y<T.length;Y++){var I=h("<tr>");if(Y==0){if(aa&&N.rownumbers){var K=h("<th class='frozenCol rownumber'><div class='kyDatagrid-cell'></div></th>");K.attr("rowspan",T.length);K.css("height",(Q-Y)*35);I.append(K)}if(aa&&N.enableChecked){var P=h("<th class='frozenCol'></th>");P.attr("rowspan",T.length);P.css("height",(Q-Y)*35);P.append("<input type='checkbox' id='kyDatagridAllCheckbox'>");I.append(P)}}var S=T[Y];for(var X=0;X<S.length;X++){var L=S[X];var R=h("<th></th>");R.attr("field",L.field);var U=h("<div class='kyDatagrid-cell'></div>");U.addClass("kyDatagrid-cl-"+L.field);U.append("<span>"+L.title+"</span>");if(L.sortable==true){R.addClass("sortable");U.append("<span class='kyDatagrid-sort-icon'></span>");U.append("<span class='right kyDatagrid-dropdown-menu'></span>");if(L.field==G.sort&&G.order=="desc"){R.addClass("down")}else{if(L.field==G.sort&&G.order=="asc"){R.addClass("up")}}}if(L.hidden==true){R.css("display","none")}if(L.childColumns==undefined||k(L.childColumns)<=0){R.attr("rowspan",O-Y);var W=L.titleAlign||L.align;switch(W){case"left":R.css("text-align","left");break;case"center":R.css("text-align","center");break;case"right":R.css("text-align","right");break;default:R.css("text-align","left");break}R.css("height",(Q-Y)*35)
}else{R.css("text-align","center");R.attr("colspan",k(L.childColumns))}R.append(U);I.append(R)}Z.append(I)}return Z[0].outerHTML}function B(P,U,S){var V=h(P).kyDatagrid("options");var L;if(!S){L=p(V.columns)}else{L=p(V.frozenColumns)}var O=h("<tbody>");if(U.length>0){for(var N=0;N<U.length;N++){var Q=h("<tr>");var T=U[N];Q.attr("id","kyDatagrid-row-"+N).attr("index",N).addClass("kyDatagrid-row");if(S&&V.rownumbers){var I=h("<td class='frozenCol rownumber'>");I.html((V.pageNumber-1)*V.pageSize+N+1);Q.append(I)}if(S&&V.enableChecked){var G=h("<td>");G.html('<input type="checkbox" class="kyDatagridCheckbox"/>');G.addClass("frozenCol");Q.append(G)}for(var M=0;M<L.length;M++){var K=h("<td>");var J=L[M];var R=T[J.field]||"";var H=h("<div>");H.addClass("kyDatagrid-cell").addClass("kyDatagrid-cl-"+J.field);if(J.formatter){H.append(J.formatter(R,T,N))}else{H.html(R)}if(J.hidden){K.css("display","none")}K.attr("field",J.field);K.append(H);switch(J.align){case"left":K.css("text-align","left");break;case"center":K.css("text-align","center");break;case"right":K.css("text-align","right");break}Q.append(K)}V.trAttr(Q,T,N);O.append(Q)}}return O[0].outerHTML}function f(I,J){h(I).parents(".kyDatagrid-wrap").find(".kyDatagrid-view style[kyDatagrid]").remove();var H=["<style type='text/css' kyDatagrid='true' scoped>"];for(var G=0;G<J.length;G++){H.push(".kyDatagrid-"+h(I).attr("id")+" "+J[G])}H.push("</style>");h(H.join("\n")).appendTo(h(I).parents(".kyDatagrid-wrap .kyDatagrid-view"))}function t(I,L){I=I||[];L=L||0;var G=++L;for(var H=0;H<I.length;H++){var J=I[H];if(J.childColumns&&J.childColumns.length>0){var K=t(J.childColumns,L);if(K>G){G=K}}}return G}function e(H,L,K){K=K||0;var J=++K;for(var G=0;G<H.length;G++){var I=H[G];L[K-1].push(I);if(I.childColumns&&I.childColumns.length>0){L=e(I.childColumns,L,J)}}return L}function u(P,O,M,I,L){L=L||[];O=O||0;M=M||0;I=I||P.length;console.log("调用了一次方法");var H=M;var G=P[O];for(var N=0;N<I;N++,M++){var K=G[M];console.log(JSON.stringify(K),"第"+(O+1)+"行,从第"+(M+1)+"条开始取"+I+"条,共"+G.length+"条数据");var J=0;if(K.colspan!=undefined){J=parseInt(K.colspan)}if(J>0&&(O+1)<P.length){console.log("进入了这里！！！",J,(O+1),P.length);K.childColumns=u(P,O+1,H,J);H+=J}L.push(K)}return L}function k(H,J){J=J||0;H=H||[];for(var G=0;G<H.length;G++){var I=H[G];if(I.childColumns&&k(I.childColumns,J)>0){J=k(I.childColumns,J)}else{if(I.hidden==undefined||!I.hidden){J++}}}return J}function o(I){I=I||[];var G=0;for(var H=0;H<I.length;H++){var K=I[H];if(!K.hidden){var J=K.width==undefined?100:K.width;G+=J}}return G}function p(I,H){I=I||[];H=H||[];for(var G=0;G<I.length;G++){var J=I[G];if(J.childColumns&&k(J.childColumns)>0){H=p(J.childColumns,H)}else{H.push(J)}}return H}function n(H){H=H||[];for(var G=0;G<H.length;G++){var I=H[G];if(I.hidden){H.splice(G,1)}}return H}function c(L,K){var J=h.data(L,"kyDatagrid");var H=J.options;var I=H.columns;I=m(I,K,"hidden",true);var G=J.headTable;h(G).empty().append(r(L));w(L)}function E(L,K){var J=h.data(L,"kyDatagrid");var H=J.options;var I=H.columns;I=m(I,K,"hidden",false);var G=J.headTable;h(G).empty().append(r(L));w(L)}function m(I,L,G,K){for(var H=0;H<I.length;H++){var J=I[H];if(L==J.field){J[G]=K}else{if(J.childColumns!=undefined&&J.childColumns.length>0){J.childColumns=m(J.childColumns,L,G,K)}}}return I}})(jQuery);