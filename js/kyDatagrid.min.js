(function(d){d.fn.kyDatagrid=function(u,v){if(typeof u=="string"){return d.fn.kyDatagrid.methods[u](this,v)}u=u||{};return this.each(function(){var w=d.data(this,"kyDatagrid");if(w){d.extend(w.options,u)}else{u=d.extend({},d.fn.kyDatagrid.defaults,d.fn.kyDatagrid.parseOptions(this),u);d.data(this,"kyDatagrid",{options:u});m(this)}})};d.fn.kyDatagrid.defaults={title:undefined,url:undefined,idField:"id",method:"post",queryParams:{},enableChecked:false,columns:undefined,rownumbers:true,pagination:true,pageNumber:1,singleSelect:true,pageSize:10,pageList:[10,20,30,40,50],maxPageLen:10,emptyMsg:"记录为空!",onLoadSuccess:function(u){},onLoadError:function(){},onDblClickRow:function(u,v){},onSelect:function(u,v){},onUnSelect:function(u,v){},onSelectAll:function(u){},onUnSelectAll:function(u){}};d.fn.kyDatagrid.methods={options:function(u){return d.data(u[0],"kyDatagrid").options},reload:function(v,u){return v.each(function(){m(this,u)})},remove:function(u){return u.each(function(){s(this)})},getSelected:function(u){return k(u[0])},getSelections:function(u){return d.data(u[0],"kyDatagrid").selectedRows||[]},checkRow:function(v,u){return v.each(function(){n(this,u)})},checkAll:function(u){return u.each(function(){i(this)})},unCheckRow:function(v,u){return v.each(function(){t(this,u)})},unCheckAll:function(u){return u.each(function(){q(this)})}};d.fn.kyDatagrid.parseOptions=function(u){return{}};function c(y,w,u){if(u.pagination&&w.length>u.pageSize){w=w.slice(0,u.pageSize)}var z=[];var v=u.pageSize-w.length;while(v-->0){z.push("")}d(y).wrap(d("<div class='kyDatagrid-wrap'></div>")).wrap("<div class='kyDatagrid-view'></div>");var A=d(window).height();d(y).append(j(y));d(y).append(p(y,w));d(y).addClass("data-table kyDatagrid");var x=d.data(y,"kyDatagrid").selectedRows||[]}function r(M,J,v){var I=d(M).parents(".kyDatagrid-wrap");var J=parseInt(J);var N=parseInt(v.pageNumber);var B=parseInt(v.maxPageLen);var L=parseInt(v.pageSize);var w=(J%L==0)?J/L:(parseInt(J/L)+1);B=w>B?B:w;var K=1;if(N<B/2){K=1}else{if((w-N)<B/2){K=w-B+1}else{K=N-B/2}}K=K>0?K:1;var y=[];var H=K+B;for(K;K<H;K++){y.push(K)}var u=J>0?(N-1)*L+1:0;var E=N*L>J?J:N*L;var G=d("<div class='pagination'></div>");G.append('<div class="left list-show">显示第'+u+"到"+E+"条，共"+J+"条</div>");var C=d('<ul class="right page-box"></ul>');var D=d("<li class='pre'><a href='javascript:void(0)'>上一页</a></li>");D.attr("pageno",N-1);if(N<=1){D.find("a").addClass("hui")}C.append(D);for(var F=0;F<y.length;F++){var x=y[F];var z=d("<li class='num'><a href='javascript:void(0)'></a></li>");z.attr("pageno",x);z.find("a").html(x);if(x==N){z.addClass("active")}C.append(z)}var A=d("<li class='next'><a href='javascript:void(0)'>下一页</a></li>");A.attr("pageno",N+1);if(N>=w){A.find("a").addClass("hui")}C.append(A);G.append(C);G.append("<div class='clearfix'></div>");d(I).append(G);d(I).find(".pagination .page-box li a").on("click",function(){if(d(this).hasClass("hui")||d(this).hasClass("cur")){return}var Q=d(this).parent().attr("pageno");if(Q==N){return}else{var P=d(M).kyDatagrid("options");P.pageNumber=Q;var O=d.data(M,"kyDatagrid");O.options=P;d.data(M,"kyDatagrid",O);d(M).kyDatagrid("reload")}})}function m(w,x){var u=d.data(w,"kyDatagrid").options;if(x!=undefined&&typeof x=="object"){u.queryParams=x}var v=u.queryParams,x;if(u.pagination){d.extend(v,{page:u.pageNumber,rows:u.pageSize})}d.ajax({url:u.url,type:u.method,data:v,dataType:"json",success:function(z){z=o(u,z);s(w);c(w,z.rows,u);if(u.pagination){r(w,z.total,u)}b(w);var y=d.data(w,"kyDatagrid");y.options=u;y.rows=z.rows;d.data(w,"kyDatagrid",y);u.onLoadSuccess(z)},error:function(y,A,z){c(w,[],u);if(u.pagination){r(w,0,u)}u.onLoadError()}})}function s(u){d(u).unwrap(".kyDatagrid-view").unwrap(d("<div class='kyDatagrid-wrap'></div>"));d(u).html("");d(u).next(".pagination").remove()}function b(v){var u=d(v).kyDatagrid("options");d(v).find("th.sortable").click(function(y){var w="desc";var z=d(this).attr("field");if(d(this).hasClass("down")){w="asc"}var x=d.data(v,"kyDatagrid").options.queryParams;x.sort=z;x.order=w;m(v,x);y.stopPropagation()});d(v).find(".kyDatagrid-row").click(function(x){if(d(this).hasClass("empty-row")){return}var y=d.data(v,"kyDatagrid").rows;var w=d(this).attr("index");if(u.singleSelect){if(e(v,w)){q(v)}else{q(v);n(v,w)}}else{if(!d(this).hasClass("selected")){n(v,w)}else{t(v,w)}}x.stopPropagation()});d(v).find(".kyDatagrid-row").dblclick(function(x){var y=d.data(v,"kyDatagrid").rows;var w=d(this).attr("index");d.data(v,"kyDatagrid").options.onDblClickRow(w,y[w]);x.stopPropagation()});if(u.enableChecked){d(v).find("#kyDatagridAllCheckbox").on("click",function(){if(u.singleSelect){d(this).prop("checked",false)}else{if(!d(this).prop("checked")){q(v)}else{i(v)}}})}d(v).find("a,button").click(function(w){w.stopPropagation()})}function e(v,u){var w=d(v).find("#kyDatagrid-row-"+u);if(w.hasClass("selected")){return true}return false}function n(A,y){var C=d(A).find("#kyDatagrid-row-"+y);if(C.hasClass("selected")){return}C.addClass("selected");
    var B=d.data(A,"kyDatagrid");var D=B.rows||[];var v=B.selectedRows||[];var E=B.options;if(E.enableChecked){C.find(".kyDatagridCheckbox").prop("checked",true);var u=E.idField;var z=false;for(var x=0;x<v.length;x++){if(v[x][u]==D[y][u]){z=true}}if(!z){v.push(D[y]);B.selectedRows=v}d.data(A,"kyDatagrid",B)}var w=true;for(var x=0;x<D.length;x++){if(!d("#kyDatagrid-row-"+x).find(".kyDatagridCheckbox").prop("checked")){w=false}}if(w){d(A).find("#kyDatagridAllCheckbox").prop("checked",true);E.onSelectAll(D)}E.onSelect(y,D[y])}function t(y,x){var A=d(y).find("#kyDatagrid-row-"+x);if(!A.hasClass("selected")){return}A.removeClass("selected");var z=d.data(y,"kyDatagrid");var B=z.rows==undefined?[]:z.rows;var v=z.selectedRows==undefined?[]:z.selectedRows;var C=z.options;if(C.enableChecked){A.find(".kyDatagridCheckbox").prop("checked",false);var u=C.idField;for(var w=0;w<v.length;w++){if(v[w][u]==B[x][u]){v.splice(w,1)}}d.data(y,"kyDatagrid",z);d(y).find("#kyDatagridAllCheckbox").prop("checked",false)}C.onUnSelect(x,B[x])}function i(w){var v=d.data(w,"kyDatagrid").rows==undefined?[]:d.data(w,"kyDatagrid").rows;for(var u=0;u<v.length;u++){n(w,u)}}function q(w){var v=d.data(w,"kyDatagrid").rows==undefined?[]:d.data(w,"kyDatagrid").rows;for(var u=0;u<v.length;u++){t(w,u)}}function k(x){var w=d(x).find("tr.selected");if(w.length>0){var v=d.data(x,"kyDatagrid").rows;var u=parseInt(d(w[0]).attr("index"));return v[u]}return null}function o(w,A){var v=w.pageSize;var u=w.pageNumber;var z=[];if(A instanceof Array){if(w.pagination){for(var x=0,B=(u-1)*v;x<v;x++){if(B+x>=A.length){break}z.push(A[B+x])}}else{z=A}return{total:A.length,rows:z}}else{if(A instanceof Object){var y=A.rows;if(w.pagination&&y.length>v){for(var x=0;x<v;x++){z.push(y[x])}A.rows=z}return A}else{alert("unsupport data type.you should use Array or JSON data to create a table")}}}function j(L){var z=d(L).kyDatagrid("options");var A=l(z.columns);var y=g(h(z.columns));var u=z.queryParams;var F=new Array(A);for(var J=0;J<A;J++){F[J]=[]}F=a(z.columns,F);var K=d("<thead>");for(var J=0;J<F.length;J++){var v=d("<tr>");if(J==0){if(z.rownumbers){var w=d("<th><div class='kyDatagrid-cell'></div></th>");w.css({"min-width":"36px","max-width":"36px"}).attr("rowspan",F.length);v.append(w)}if(z.enableChecked){var B=d("<th></th>");B.css({"min-width":"36px","max-width":"36px","text-align":"center"}).attr("rowspan",F.length);B.append("<input type='checkbox' id='kyDatagridAllCheckbox'>");v.append(B)}}var E=F[J];for(var H=0;H<E.length;H++){var x=E[H];var D=d("<th></th>");D.attr("field",x.field);var G=d("<div class='kyDatagrid-cell'></div>");G.append("<span>"+x.title+"</span>");if(x.sortable==true){D.addClass("sortable");G.append("<span class='kyDatagrid-sort-icon'></span>");if(x.field==u.sort&&u.order=="desc"){D.addClass("down")}else{if(x.field==u.sort&&u.order=="asc"){D.addClass("up")}}}if(x.hidden==true){D.css("display","none")}if(x.childColumns==undefined||x.childColumns.length<=0){D.attr("rowspan",A-J);var I=x.titleAlign||x.align;switch(I){case"left":D.css("text-align","left");break;case"center":D.css("text-align","center");break;case"right":D.css("text-align","right");break;default:D.css("text-align","left");break}var C=x.width==undefined?100:x.width;D.css("width",parseInt(C/y*100)+"%")}else{D.css("text-align","center");D.attr("colspan",f(x.childColumns))}D.append(G);v.append(D)}K.append(v)}return K[0].outerHTML}function p(D,H){var I=d(D).kyDatagrid("options");var z=h(I.columns);var C=d("<tbody>");for(var B=0;B<H.length;B++){var E=d("<tr>");var G=H[B];E.attr("id","kyDatagrid-row-"+B).attr("index",B).addClass("kyDatagrid-row");if(I.rownumbers){var w=d("<td>");w.html((I.pageNumber-1)*I.pageSize+B+1);w.addClass("center");E.append(w)}if(I.enableChecked){var u=d("<td>");u.html('<input type="checkbox" class="kyDatagridCheckbox"/>');u.addClass("center");E.append(u)}for(var A=0;A<z.length;A++){var y=d("<td>");var x=z[A];var F=G[x.field]||"";var v=d("<div>");v.addClass("kyDatagrid-cell");if(x.formatter){v.append(x.formatter(F,G,B))}else{v.html(F)}y.append(v);switch(x.align){case"left":y.css("text-align","left");break;case"center":y.css("text-align","center");break;case"right":y.css("text-align","right");break;default:y.css("text-align","left");break}E.append(y)}C.append(E)}return C[0].outerHTML}function l(w,z){z=z||0;var u=++z;for(var v=0;v<w.length;v++){var x=w[v];if(x.childColumns&&x.childColumns.length>0){var y=l(x.childColumns,z);if(y>u){u=y}}}return u}function a(v,z,y){y=y||0;var x=++y;for(var u=0;u<v.length;u++){var w=v[u];z[y-1].push(w);if(w.childColumns&&w.childColumns.length>0){z=a(w.childColumns,z,x)}}return z}function f(v,x){x=x||0;for(var u=0;u<v.length;u++){var w=v[u];if(w.childColumns&&w.childColumns.length>0){x=f(w.childColumns,x)}else{x++}}return x}function g(w){var u=0;for(var v=0;v<w.length;v++){var y=w[v];if(!y.hidden){var x=y.width==undefined?100:y.width;u+=x}}return u}function h(w,v){v=v||[];for(var u=0;u<w.length;u++){var x=w[u];if(x.childColumns&&x.childColumns.length>0){v=h(x.childColumns,v)
}else{if(!x.hidden){v.push(x)}}}return v}})(jQuery);