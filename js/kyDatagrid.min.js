(function(g){g.fn.kyDatagrid=function(E,F){if(typeof E=="string"){return g.fn.kyDatagrid.methods[E](this,F)}E=E||{};return this.each(function(){var G=g.data(this,"kyDatagrid");if(G){g.extend(G.options,E)}else{E=g.extend({},g.fn.kyDatagrid.defaults,g.fn.kyDatagrid.parseOptions(this),E);if(E.columns==undefined){E.columns=k(this)}g.data(this,"kyDatagrid",{options:E,data:{total:0,rows:[]}});y(this);u(this)}})};g.fn.kyDatagrid.defaults={title:undefined,url:undefined,height:undefined,idField:"id",method:"post",queryParams:{},fit:false,enableChecked:false,frozenColumns:[],columns:[],rownumbers:true,pagination:true,pageNumber:1,singleSelect:true,pageSize:10,scrollBarWidth:18,pageList:[10,20,30,40,50],minColWidth:100,emptyMsg:"记录为空!",trAttr:function(F,G,E){},onLoadSuccess:function(E){},onLoadError:function(){},onDblClickRow:function(E,F){},onSelect:function(E,F){},onUnSelect:function(E,F){},onSelectAll:function(E){},onUnSelectAll:function(E){}};g.fn.kyDatagrid.methods={options:function(E){return g.data(E[0],"kyDatagrid").options},reload:function(F,E){return F.each(function(){u(this,E)})},remove:function(E){return E.each(function(){B(this)})},getSelected:function(E){return r(E[0])},getSelections:function(E){return g.data(E[0],"kyDatagrid").selectedRows||[]},checkRow:function(F,E){return F.each(function(){v(this,E)})},checkAll:function(E){return E.each(function(){p(this)})},unCheckRow:function(F,E){return F.each(function(){D(this,E)})},unCheckAll:function(E){return E.each(function(){A(this)})},loadData:function(F,E){return F.each(function(){a(this,E)})},changePage:function(F,E){return F.each(function(){w(this,E)})},hideColumn:function(F,E){return F.each(function(){b(this,E)})},showColumn:function(F,E){return F.each(function(){C(this,E)})}};g.fn.kyDatagrid.parseOptions=function(E){return{}};function k(L){var N=g(L);if(N.find("tr").length==0){return[]}var H=[];if(N.find("thead").length>0){var K=N.find("thead tr");for(var J=0;J<K.length;J++){var M=K[J];var E=g(M).find("th");for(var I=0;I<E.length;I++){var F=E[I];G={};G.title=g(F).html();G.field=g(F).attr("field");G.sortable=g(F).attr("sortable")=="true";H.push(G)}}return H}else{var M=N.find("tr")[0];var E=g(M).find("th");for(var J=0;J<E.length;J++){var F=E[J];var G={};G.title=g(F).html();G.field=g(F).attr("field");G.sortable=g(F).attr("sortable")=="true";H.push(G)}return H}}function y(J){var G=g(J).kyDatagrid("options");g(J).css("display","none");g(J).wrap(g("<div class='kyDatagrid-wrap'></div>")).wrap(g("<div class='kyDatagrid-view'></div>"));var E=g(J).parents(".kyDatagrid-wrap");var I=E.find(".kyDatagrid-view");I.append("<div class='kyDatagrid-view-left'>").append("<div class='kyDatagrid-view-right'>");var H=E.find(".kyDatagrid-view-left");var F=E.find(".kyDatagrid-view-right");H.append("<div class='kyDatagrid-head'>").append("<div class='kyDatagrid-body'>");H.find(".kyDatagrid-head").append("<table class='data-table'>");H.find(".kyDatagrid-body").append("<table class='data-table'>");H.find(".kyDatagrid-head table").append(q(J,G.frozenColumns,true));F.append("<div class='kyDatagrid-head'>").append("<div class='kyDatagrid-body'>");F.find(".kyDatagrid-head").append("<table class='data-table'>");F.find(".kyDatagrid-head table").append(q(J,G.columns));F.find(".kyDatagrid-body").append("<table class='data-table'>");g.data(J,"kyDatagrid").headTable=F.find(".kyDatagrid-head table");g.data(J,"kyDatagrid").bodyTable=F.find(".kyDatagrid-body table");I.contextmenu(function(L){var K=L.target;console.log(K)})}function a(I,H){var G=g(I).kyDatagrid("options");var H=x(G,H);var E=g(I).parents(".kyDatagrid-wrap");E.find(".kyDatagrid-view-left .kyDatagrid-body table").empty().append(z(I,H.rows,true));E.find(".kyDatagrid-view-right .kyDatagrid-body table").empty().append(z(I,H.rows));var F=g.data(I,"kyDatagrid");F.options=G;F.data=H;g.data(I,"kyDatagrid",F);if(G.pagination){i(I)}f(I);t(I);c(I);return H}function f(G){var F=g(G).kyDatagrid("options");var E=g(G).parents(".kyDatagrid-wrap");E.find("th.sortable").unbind("click").click(function(J){var H="desc";var K=g(this).attr("field");if(g(this).hasClass("down")){H="asc"}E.find("th.sortable").removeClass("down").removeClass("up");if(H=="asc"){g(this).addClass("up")}else{g(this).addClass("down")}var I=g.data(G,"kyDatagrid").options.queryParams;I.sort=K;I.order=H;u(G,I)});E.find(".kyDatagrid-view-right .kyDatagrid-body").scroll(function(I){var H=g(this).scrollTop();E.find(".kyDatagrid-view-left .kyDatagrid-body").scrollTop(H)});E.find(".kyDatagrid-row").hover(function(){var H=g(this).attr("index");g(G).parents(".kyDatagrid-wrap").find("tr#kyDatagrid-row-"+H).addClass("hover")},function(){var H=g(this).attr("index");g(G).parents(".kyDatagrid-wrap").find("tr#kyDatagrid-row-"+H).removeClass("hover")});E.find(".kyDatagrid-row").unbind("click").click(function(I){if(g(this).hasClass("empty-row")){return}var J=g.data(G,"kyDatagrid").data.rows;var H=g(this).attr("index");if(F.singleSelect){if(h(G,H)){A(G)}else{A(G);v(G,H)}}else{if(!g(this).hasClass("selected")){v(G,H)}else{D(G,H)}}});E.find(".kyDatagrid-row").unbind("dblclick").dblclick(function(I){var J=g.data(G,"kyDatagrid").data.rows;
    var H=g(this).attr("index");g.data(G,"kyDatagrid").options.onDblClickRow(H,J[H])});if(F.enableChecked){E.find("#kyDatagridAllCheckbox").unbind("click").click(function(){if(F.singleSelect){g(this).prop("checked",false)}else{if(!g(this).prop("checked")){A(G)}else{p(G)}}})}g(window).resize(function(){t(G);c(G)})}function i(L){var R=g(L).kyDatagrid("options");g(L).parents(".kyDatagrid-wrap").find(".pagination").remove();var Q=g.data(L,"kyDatagrid").data.total;var G=g(L).parents(".kyDatagrid-wrap");Q=parseInt(Q);var E=parseInt(R.pageNumber);var O=parseInt(R.pageSize);var K=(Q%O==0)?Q/O:(parseInt(Q/O)+1);K=K==0?1:K;var H=Q>0?(E-1)*O+1:0;var M=E*O>Q?Q:E*O;var P=g("<div class='pagination '></div>");var N=g('<div class="page-box">'+'<div class="left show-g">'+"<ul>"+'<li><select class="pagination-page-list"></select></li>'+'<li><a href="javascript:void(0)" class="pagination-first"></a><a href="javascript:void(0)" class="pagination-prev"></a></li>'+'<li>第<input type="text" class="pagination-num" name="pagination-num"> 共<span class="pagination-total-page"></span>页 </li>'+'<li> <a href="javascript:void(0)" class="pagination-next"></a><a href="javascript:void(0)" class="pagination-last"></a></li>'+'<li> <a href="javascript:void(0)" class="pagination-load"></a></li>'+"</ul>"+"</div>"+'<div class="pagination-info">显示第0到0条，共0条</div>'+"</div>");var F=N.find("select.pagination-page-list");for(var I=0;I<R.pageList.length;I++){var J=g("<option>");J.html(R.pageList[I]);J.val(R.pageList[I]);if(R.pageSize==R.pageList[I]){J.prop("selected",true)}J.appendTo(F)}F.on("change",function(T){var S=g(this).val();R.pageSize=S;g.data(L,"kyDatagrid").options=R;w(L,1)});P.append(N);N.find("input.pagination-num").val(E);P.on("keyup","input.pagination-num",function(S){if(S.which==13){var T=g(this).val();w(L,T)}});P.find(".pagination-total-page").html(K);P.find(".pagination-info").html("显示第"+H+"到"+M+"条，共"+Q+"条");g(G).append(P);P.find(".pagination-first").on("click",function(){w(L,1)});P.find(".pagination-prev").on("click",function(){w(L,E-1)});P.find(".pagination-next").on("click",function(){w(L,E+1)});P.find(".pagination-last").on("click",function(){w(L,K)});P.find(".pagination-load").on("click",function(){u(L)})}function w(I,E){var F=g(I).kyDatagrid("options");var H=g.data(I,"kyDatagrid");var G=(H.data.total%F.pageSize==0)?H.data.total/F.pageSize:(parseInt(H.data.total/F.pageSize)+1);if((/^(\+|-)?\d+$/.test(E))&&E>0){if(E>G){E=G}}else{E=1}F.pageNumber=E;u(I)}function u(I,J){var E=g(I).kyDatagrid("options");if(J!=undefined&&typeof J=="object"){E.queryParams=J}var F=E.queryParams,J;if(E.pagination){g.extend(F,{page:E.pageNumber,rows:E.pageSize})}var H=[];if(E.url!=undefined){g.ajax({url:E.url,type:E.method,data:F,dataType:"json",success:function(K){K=a(I,K);E.onLoadSuccess(K.rows)},error:function(K,M,L){a(I,[]);E.onLoadError()}})}else{var G=E.data||[];G=a(I,G);E.onLoadSuccess(G.rows)}}function B(E){g(E).siblings().remove();g(E).unwrap().siblings().remove();g(E).unwrap()}function t(I){var M=g(I).kyDatagrid("options");var J=g(I).parents(".kyDatagrid-wrap");if(M.height||M.fit){var E=g(window).height()-10;var F=g(I).parents(".kyDatagrid-wrap").offset().top;var H=35*s(M.columns);var L=g(".pagination").height();var K=M.height||E-F;K=K<(H+L)?H+L:K;var G=K;if(M.pagination){G-=31}J.css("height",K);J.find(".kyDatagrid-view").css("height",G+M.scrollBarWidth);J.find(".kyDatagrid-view-left").css("height",G+M.scrollBarWidth);J.find(".kyDatagrid-view-right").css("height",G+M.scrollBarWidth);J.find(".kyDatagrid-head").css("height",H);J.find(".kyDatagrid-body").css("height",G-H)}}function c(U){var I=g(U).kyDatagrid("options");var E=[];var F=g(U).parents(".kyDatagrid-wrap");var S=F.width();S=F.parent().width();F.css("width",S);var V=m(o(I.frozenColumns));var K=n(V);var O=100*V.length;for(var R=0;R<V.length;R++){var G=V[R];if(G.hidden==undefined||!G.hidden){var J=G.width==undefined?100:G.width;var L=".kyDatagrid-cl-"+G.field;var Q=parseInt(J/K*O)-12;E.push(""+L+" {width:"+Q+"px}")}}if(I.rownumbers){O+=36}if(I.enableChecked){O+=36}F.find(".kyDatagrid-view-left").css("width",O);F.find(".kyDatagrid-view-left .kyDatagrid-head").css("width",O);F.find(".kyDatagrid-view-left .kyDatagrid-body").css("width",O);F.find(".kyDatagrid-view-left .kyDatagrid-head table").css("width",O);F.find(".kyDatagrid-view-left .kyDatagrid-body table").css("width",O);var M=m(o(I.columns));var H=n(M);var T=S-O;var P=M.length*100;var N=T>P?T:P;N=N-I.scrollBarWidth;F.find(".kyDatagrid-view-right").css("width",T);F.find(".kyDatagrid-view-right .kyDatagrid-head").css("width",N+I.scrollBarWidth);F.find(".kyDatagrid-view-right .kyDatagrid-body").css("width",N+I.scrollBarWidth);F.find(".kyDatagrid-view-right .kyDatagrid-head table").css("width",N);F.find(".kyDatagrid-view-right .kyDatagrid-body table").css("width",N);for(var R=0;R<M.length;R++){var G=M[R];if(G.hidden==undefined||!G.hidden){var J=G.width==undefined?100:G.width;var L=".kyDatagrid-cl-"+G.field;var Q=Math.floor(J/H*N)-13;E.push(""+L+" {width:"+Q+"px}")}}e(U,E)}function h(F,E){var G=g(F).parents(".kyDatagrid-wrap").find("#kyDatagrid-row-"+E);
    if(G.hasClass("selected")){return true}return false}function v(K,I){var L=g(K).parents(".kyDatagrid-wrap");var N=L.find("tr#kyDatagrid-row-"+I);if(N.hasClass("selected")){return}N.addClass("selected");var M=g.data(K,"kyDatagrid");var O=M.data.rows||[];var F=M.selectedRows||[];var P=M.options;if(P.enableChecked){N.find(".kyDatagridCheckbox").prop("checked",true)}var E=P.idField;var J=false;for(var H=0;H<F.length;H++){if(F[H][E]==O[I][E]){J=true}}if(!J){F.push(O[I]);M.selectedRows=F}g.data(K,"kyDatagrid",M);var G=true;for(var H=0;H<O.length;H++){if(!g("#kyDatagrid-row-"+H).find(".kyDatagridCheckbox").prop("checked")){G=false}}if(G){L.find("#kyDatagridAllCheckbox").prop("checked",true);P.onSelectAll(O)}P.onSelect(I,O[I])}function D(I,H){var J=g(I).parents(".kyDatagrid-wrap");var L=J.find("tr#kyDatagrid-row-"+H);if(!L.hasClass("selected")){return}L.removeClass("selected");var K=g.data(I,"kyDatagrid");var M=K.data.rows==undefined?[]:K.data.rows;var F=K.selectedRows==undefined?[]:K.selectedRows;var N=K.options;if(N.enableChecked){L.find(".kyDatagridCheckbox").prop("checked",false);J.find("#kyDatagridAllCheckbox").prop("checked",false)}var E=N.idField;for(var G=0;G<F.length;G++){if(F[G][E]==M[H][E]){F.splice(G,1)}}g.data(I,"kyDatagrid",K);N.onUnSelect(H,M[H])}function p(G){var F=g.data(G,"kyDatagrid").data.rows==undefined?[]:g.data(G,"kyDatagrid").data.rows;for(var E=0;E<F.length;E++){v(G,E)}}function A(G){var F=g.data(G,"kyDatagrid").data.rows==undefined?[]:g.data(G,"kyDatagrid").data.rows;for(var E=0;E<F.length;E++){D(G,E)}}function r(H){var G=g(H).parents(".kyDatagrid-wrap").find("tr.selected");if(G.length>0){var F=g.data(H,"kyDatagrid").data.rows;var E=parseInt(g(G[0]).attr("index"));return F[E]}return null}function x(G,J){var F=G.pageSize;var E=G.pageNumber;var I=[];if(J instanceof Array){if(G.pagination){for(var H=0,K=(E-1)*F;H<F;H++){if(K+H>=J.length){break}I.push(J[K+H])}}else{I=J}return{total:J.length,rows:I}}else{if(J instanceof Object){return J}else{alert("unsupport data type.you should use Array or JSON data to create a table")}}}function q(Z,H,Y){var L=g(Z).kyDatagrid("options");var M=s(H);var T=s(L.columns);var F=s(L.frozenColumns);var O=T>F?T:F;var K=n(o(H));var E=L.queryParams;var R=new Array(M);for(var W=0;W<M;W++){R[W]=[]}R=d(H,R);var X=g("<thead>");for(var W=0;W<R.length;W++){var G=g("<tr>");if(W==0){if(Y&&L.rownumbers){var I=g("<th class='frozenCol rownumber'><div class='kyDatagrid-cell'></div></th>");I.attr("rowspan",R.length);I.css("height",(O-W)*35);G.append(I)}if(Y&&L.enableChecked){var N=g("<th class='frozenCol'></th>");N.attr("rowspan",R.length);N.css("height",(O-W)*35);N.append("<input type='checkbox' id='kyDatagridAllCheckbox'>");G.append(N)}}var Q=R[W];for(var V=0;V<Q.length;V++){var J=Q[V];var P=g("<th></th>");P.attr("field",J.field);var S=g("<div class='kyDatagrid-cell'></div>");S.addClass("kyDatagrid-cl-"+J.field);S.append("<span>"+J.title+"</span>");if(J.sortable==true){P.addClass("sortable");S.append("<span class='kyDatagrid-sort-icon'></span>");S.append("<span class='right kyDatagrid-dropdown-menu'></span>");if(J.field==E.sort&&E.order=="desc"){P.addClass("down")}else{if(J.field==E.sort&&E.order=="asc"){P.addClass("up")}}}if(J.hidden==true){P.css("display","none")}if(J.childColumns==undefined||j(J.childColumns)<=0){P.attr("rowspan",M-W);var U=J.titleAlign||J.align;switch(U){case"left":P.css("text-align","left");break;case"center":P.css("text-align","center");break;case"right":P.css("text-align","right");break;default:P.css("text-align","left");break}P.css("height",(O-W)*35)}else{P.css("text-align","center");P.attr("colspan",j(J.childColumns))}P.append(S);G.append(P)}X.append(G)}return X[0].outerHTML}function z(V,O,U){var K=g(V).kyDatagrid("options");var H;if(!U){H=o(K.columns)}else{H=o(K.frozenColumns)}var E=g("<tbody>");if(O.length>0){for(var T=0;T<O.length;T++){var G=g("<tr>");var M=O[T];G.attr("id","kyDatagrid-row-"+T).attr("index",T).addClass("kyDatagrid-row");if(U&&K.rownumbers){var L=g("<td class='frozenCol rownumber'>");L.html((K.pageNumber-1)*K.pageSize+T+1);G.append(L)}if(U&&K.enableChecked){var F=g("<td>");F.html('<input type="checkbox" class="kyDatagridCheckbox"/>');F.addClass("frozenCol");G.append(F)}for(var S=0;S<H.length;S++){var N=g("<td>");var J=H[S];var R=M[J.field]||"";var P=g("<div>");P.addClass("kyDatagrid-cell").addClass("kyDatagrid-cl-"+J.field);if(J.formatter){P.append(J.formatter(R,M,T))}else{P.html(R)}if(J.hidden){N.css("display","none")}N.attr("field",J.field);N.append(P);switch(J.align){case"left":N.css("text-align","left");break;case"center":N.css("text-align","center");break;case"right":N.css("text-align","right");break}G.append(N)}K.trAttr(G,M,T);E.append(G)}}else{var G=g("<tr>");var Q=g("<td>");var I=j(H);if(K.rownumbers){I++}if(K.enableChecked){I++}Q.attr("colspan",I).css("text-align","center");var P=g("<div>");P.addClass("kyDatagrid-cell");P.html(K.emptyMsg);Q.append(P);G.append(Q);E.append(G)}return E[0].outerHTML}function e(G,H){g(G).parents(".kyDatagrid-wrap").find(".kyDatagrid-view style[kyDatagrid]").remove();
    var F=["<style type='text/css' kyDatagrid='true'>"];for(var E=0;E<H.length;E++){F.push(H[E])}F.push("</style>");g(F.join("\n")).appendTo(g(G).parents(".kyDatagrid-wrap .kyDatagrid-view"))}function s(G,J){J=J||0;var E=++J;for(var F=0;F<G.length;F++){var H=G[F];if(H.childColumns&&H.childColumns.length>0){var I=s(H.childColumns,J);if(I>E){E=I}}}return E}function d(F,J,I){I=I||0;var H=++I;for(var E=0;E<F.length;E++){var G=F[E];J[I-1].push(G);if(G.childColumns&&G.childColumns.length>0){J=d(G.childColumns,J,H)}}return J}function j(F,H){H=H||0;for(var E=0;E<F.length;E++){var G=F[E];if(G.childColumns&&j(G.childColumns,H)>0){H=j(G.childColumns,H)}else{if(G.hidden==undefined||!G.hidden){H++}}}return H}function n(G){var E=0;for(var F=0;F<G.length;F++){var I=G[F];if(!I.hidden){var H=I.width==undefined?100:I.width;E+=H}}return E}function o(G,F){F=F||[];for(var E=0;E<G.length;E++){var H=G[E];if(H.childColumns&&j(H.childColumns)>0){F=o(H.childColumns,F)}else{F.push(H)}}return F}function m(F){for(var E=0;E<F.length;E++){var G=F[E];if(G.hidden){F.splice(E,1)}}return F}function b(J,I){var H=g.data(J,"kyDatagrid");var F=H.options;var G=F.columns;G=l(G,I,"hidden",true);var E=H.headTable;g(E).empty().append(q(J));u(J)}function C(J,I){var H=g.data(J,"kyDatagrid");var F=H.options;var G=F.columns;G=l(G,I,"hidden",false);var E=H.headTable;g(E).empty().append(q(J));u(J)}function l(G,J,E,I){for(var F=0;F<G.length;F++){var H=G[F];if(J==H.field){H[E]=I}else{if(H.childColumns!=undefined&&H.childColumns.length>0){H.childColumns=l(H.childColumns,J,E,I)}}}return G}})(jQuery);